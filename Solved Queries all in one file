/*
Supplier/retail case study
BY:Subhash 
Date Modified - 12-04-23

*/

use Supplier
go
--1.List the month-wise average supply of parts supplied for all parts. Provide the information only if the average is higher than 20.
			select  avg(qtysupplied) as 'avg qtnty supplied',datepart (mm,DATEOFSUPPLY) as 'month of supply',SID
			from SupplyDetails
			group by SID,datepart (mm,DATEOFSUPPLY)
			having avg(qtysupplied) > 20 
			order by 2 asc
--2.List the names of the Suppliers who do not supply part with PID ‘1’.
use [supplier1]
go
select m.name,m.city
from supplier_Master m
		join SupplyDetails d	
		on m.sid=d.sid
		where d.pid not in (
						select pid					
						from [dbo].[SupplyDetails]   --first get name of supplier who supplied parts pid=1
						where  pid =1)

			go
--3.List the part id, name, price and difference between price and average price of all parts.
					select pid,name,price,price-(select avg(price) from PartMaster) as 'differofavg_price'
					from PartMaster
					order by 3 desc
--4.List the names of the suppliers who have supplied at least one part where the quantity supplied is lower than 10.
					select name,city,QTYSUPPLIED,m.pid
					from supplier_Master s
							join(
							select distinct sid,pid,QTYSUPPLIED
							from [dbo].[SupplyDetails]
							where QTYSUPPLIED >=10 ) m
							on s.sid=m.sid
							order by 3 asc
							go
--5.	List the names of the suppliers who live in a city where no supply has been made.
		select * 
		from [dbo].[supplierMaster]  
		go
				select * 
				from [dbo].[SupplyDetails]
				go
						select *
						from supplierMaster m left join
							  SupplyDetails n on
							  m.city=n.CITY
							  go
--6.	List the names of the parts which have not been supplied in the month of May 2020.
				select name,DATEOFSUPPLY
				from [dbo].[PartMaster] p
				join  [dbo].[SupplyDetails] d
						on p.pid= d.pid 
						where p.pid not in 
										(
										select pid
										from  [dbo].[SupplyDetails]
										where datepart(mm,dateofsupply) =05
										)

Variation 2:
				select name,datename(mm,DATEOFSUPPLY) as 'Supplied in the month of'
				from [dbo].[PartMaster] p
				join  [dbo].[SupplyDetails] d
						on p.pid= d.pid 
						where p.pid not in 
										(
										select pid
										from  [dbo].[SupplyDetails]
										where datepart(mm,dateofsupply) =05
										)
--7.	List name and Price category for all parts. Price category has to be displayed as “Cheap” if price is less than 100, “Medium” if the price is greater than or equal to 100 and less than 500, and “Costly” if the price is greater than or equal to 500.
							select name,price,
								case  when price< 100 then 'cheap'
								when price between 100 and 500 then 'medium'
								else 'high'
								end as pricecatageory
							from PartMaster 
							order by PRICE
--8.	List the most recent supply details with information on Product name, price and no. of days elapsed since the latest supply.
		-- use slef join and use where clause to 

--9.	List the names of the suppliers who have supplied exactly 10 units of part P1.
			select name as 'suppliers who have supplied 10 pid 1'
			from supplier_Master m  join 
						(select pid,sid
						from SupplyDetails  -------	preferred querry
						where pid=1 and QTYSUPPLIED =10
						) s
						on  
						s.sid= m.sid
---10.	List the names of the parts supplied by more than one supplier.

select name as 'name of product that have more than one supplier'
from PartMaster  p join
			(		select pid
		from SupplyDetails
		group by pid
		having count (sid) >= 2   ) k
		  on p.pid = k.pid
--11.	List the names of the parts whose price is less than the average price of parts.
				select name 
				from partmaster
				where price <= (select avg(price)
									from PartMaster)
--12.	List the category-wise number of parts; exclude those where the sum is > 100 and less than 500. List in the descending order of sum.
				select name,CATEGORY, QTYONHAND as 'no.of products'
				from PartMaster
				where QTYONHAND between 100 and 500
				order by 2 asc
----13.	List the supplier name, part name and supplied quantity for all supplies made between 1st		  and 15th of June 2020.
				 select s.[name],d.pid,d.qtysupplied
					from supplierMaster s join 
										(select qtysupplied,pid,sid,DATEOFSUPPLY
										from SUPPLYDETAILS 
										where DATEOFSUPPLY between '2011-05-01 00:00:00.000'  and  '2011-06-30 00:00:00.000') as d
										on s.sid=d.sid
									go
--14.	For all products supplied by Supplier S1, List the part name and total quantity.
				select p.name as product_name,QTYSUPPLIED as 'total quantity supplied',s.pid as product_id
				from PartMaster p
					join (select sid,pid,QTYSUPPLIED
							from SupplyDetails
							where SID =101
							) as s
							on s.pid=p.pID
			
				go
--15.For the part with the minimum price, List the latest supply details (Supplier Name, Part id, Date of supply, Quantity Supplied).


			select dateofsupply as 'date of supply',qtysupplied as 'total supplied',m.name as 'supplier name',k.PID as 'product id',minimum_price
			from supplier_Master m
			join SupplyDetails s
			on s.sid =m.SID join (select top 2 min(price) as minimum_price,pid
									from PartMaster
									group by pid
									order by 1 asc
									)
									k
									on k.pid=s.pid
